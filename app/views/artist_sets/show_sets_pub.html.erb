<!-- app/views/artist_sets/show_sets_pub.html.erb -->
  <p style="color: green"><%= notice %></p>
  <p style="color: red"><%= alert %></p>

  <div>
    <h1>Buscar e Inserir do Banco de Dados</h1>
    <h2>Set: <%= @artist_set.set_list_name %> | Artist: <%= @artist.name %></h2>
  </div>

  <div>
    <%= link_to "Voltar para Sets", artist_path(@artist_set.artist), 
      role: "button" %>
  </div>

  <hr>

  <!-- PRIMEIRA TABELA: M√∫sicas no Set -->
  <h2>üéµ M√∫sicas no Set (<%= @songs.count %>)</h2>

  <!-- Formul√°rio de busca para m√∫sicas do set -->
  <%= form_with url: show_sets_pub_artist_artist_set_path(@artist_set.artist, @artist_set), method: :get, local: true do %>
    <%= label_tag :search_set, "Buscar m√∫sicas no set" %>
    <%= text_field_tag :search_set, params[:search_set] %>
    <%= submit_tag "Buscar no Set", role: "button" %>
  <% end %>

  <br>

  <% if @songs.present? %>
    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc;">
      <table>
        <thead>
          <tr>
            <th>M√∫sica</th>
            <th>Banda</th>
            <th>Status</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          <% @songs.each do |song| %>
            <% artist_song = @artist.artist_songs.find_by(song: song) %>
            <tr>
              <td><strong><%= song.name %></strong></td>
              <td><%= song.band %></td>
              <td>
                <% if artist_song %>
                  <span style="color: green;">‚úÖ No repert√≥rio</span>
                  <% if artist_song.letra.present? %>
                    <br><small style="color: #666;">Letra personalizada</small>
                  <% end %>
                <% else %>
                  <span style="color: orange;">‚ö†Ô∏è Apenas no set</span>
                <% end %>
              </td>
              <td>
                <%= button_to "Remover do Set", remover_musicas_artist_artist_set_path(@artist_set.artist, @artist_set), 
                    method: :delete, 
                    params: { song_ids: [song.id] },
                    style: "background-color: #dc3545; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;",
                    confirm: "Remover '#{song.name}' do set?",
                    local: true %>
                    
                <% if artist_song %>
                  <%= link_to "Ver Letra", artist_song_path(artist_song), 
                      style: "background-color: #0056b3; color: white; padding: 4px 8px; text-decoration: none; border-radius: 4px; font-size: 12px; margin-left: 5px;" %>
                <% end %>
                <% if artist_song %>
                  <%= link_to "Editar Letra", edit_lyrics_artist_song_path(artist_song), 
                      style: "background-color: #28a745; color: white; padding: 4px 8px; text-decoration: none; border-radius: 4px; font-size: 12px; margin-left: 5px;" %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <p style="color: gray; font-style: italic;">
      <%= params[:search_set].present? ? "Nenhuma m√∫sica encontrada no set." : "Nenhuma m√∫sica no set ainda." %>
    </p>
  <% end %>

  <hr>

  <!-- SEGUNDA TABELA: Todas as M√∫sicas Dispon√≠veis -->
  <h2>üìã Adicionar M√∫sicas ao Set</h2>

  <%= form_with url: show_sets_pub_artist_artist_set_path(@artist_set.artist, @artist_set), method: :get, local: true do %>
    <%= label_tag :query, "Buscar m√∫sica" %>
    <%= text_field_tag :query, params[:query] %>
    <%= submit_tag "Buscar", role: "button" %>
  <% end %>

  <% if @all_songs.present? %>
    <h3>
      <%= if params[:query].present?
            "M√∫sicas encontradas (#{@all_songs.count})"
          else
            "Todas as m√∫sicas dispon√≠veis (#{@all_songs.count})"
          end %>
    </h3>
    
    <%= form_with url: adicionar_musicas_artist_artist_set_path(@artist_set.artist, @artist_set), 
        method: :post, local: true, id: "multiple-songs-form" do |form| %>
      
      <div>
        <button type="button" id="select-all-btn" 
                style="background-color: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Selecionar Todas</button>
        <button type="button" id="deselect-all-btn" 
                style="background-color: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Desmarcar Todas</button>
        <button type="button" id="select-available-btn" 
                style="background-color: #ffc107; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Selecionar Apenas Dispon√≠veis</button>
        <%= form.submit "Inserir M√∫sicas Selecionadas", 
            id: "submit-selected-btn", 
            style: "background-color: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;",
            confirm: "Adicionar m√∫sicas selecionadas ao set?" %>
        <span id="selected-count" style="margin-left: 10px; font-weight: bold; color: #007bff;">0 m√∫sicas selecionadas</span>
      </div>
    
      <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc;">
        <table>
          <thead>
            <tr>
              <th style="width: 40px;">
                <input type="checkbox" id="select-all-checkbox" title="Selecionar/Desmarcar todas">
              </th>
              <th>M√∫sica</th>
              <th>Banda</th>
              <th>Status</th>
              <th>A√ß√£o Individual</th>
            </tr>
          </thead>
          <tbody>
            <% @all_songs.each do |song| %>
              <% is_in_set = @songs.include?(song) %>
              <% artist_song = @artist.artist_songs.find_by(song: song) %>
              <tr class="<%= 'already-in-set' if is_in_set %>">
                <td>
                  <input type="checkbox" 
                         name="song_ids[]" 
                         value="<%= song.id %>" 
                         class="song-checkbox <%= 'available-song' unless is_in_set %>"
                         data-song-name="<%= song.name %>"
                         data-in-set="<%= is_in_set %>"
                         <%= 'disabled' if is_in_set %>>
                </td>
                <td>
                  <span class="<%= 'text-muted' if is_in_set %>"><%= song.name %></span>
                </td>
                <td><%= song.band %></td>
                <td>
                  <% if artist_song %>
                    <span style="color: blue;">üé§ No repert√≥rio</span>
                  <% else %>
                    <span style="color: orange;">‚ûï Ser√° adicionada</span>
                  <% end %>
                </td>
                <td>
                  <% unless is_in_set %>
                    <%= button_to "Adicionar", adicionar_musicas_artist_artist_set_path(@artist_set.artist, @artist_set), 
                        method: :post, 
                        params: { song_ids: [song.id] },
                        style: "background-color: #28a745; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;",
                        local: true %>
                  <% else %>
                    <span style="color: #ccc; font-size: 12px;">-</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  <% else %>
    <p>Use a busca acima para encontrar m√∫sicas.</p>
  <% end %>

  <hr>

  <div>  
    <%= button_to "Deletar Setlist", 
        artist_artist_set_path(@artist_set.artist, @artist_set), 
        method: :delete,
        style: "background-color: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;",
        confirm: "Tem certeza que deseja deletar este set?" %>
  </div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const selectAllBtn = document.getElementById('select-all-btn');
  const deselectAllBtn = document.getElementById('deselect-all-btn');
  const selectAvailableBtn = document.getElementById('select-available-btn');
  const selectAllCheckbox = document.getElementById('select-all-checkbox');
  const selectedCountSpan = document.getElementById('selected-count');
  const submitBtn = document.getElementById('submit-selected-btn');
  
  const songCheckboxes = document.querySelectorAll('.song-checkbox');
  const availableSongCheckboxes = document.querySelectorAll('.song-checkbox.available-song');

  function updateSelectedCount() {
    const checkedBoxes = document.querySelectorAll('.song-checkbox:checked');
    const count = checkedBoxes.length;
    selectedCountSpan.textContent = `${count} m√∫sica${count !== 1 ? 's' : ''} selecionada${count !== 1 ? 's' : ''}`;
    
    submitBtn.disabled = count === 0;
    submitBtn.style.opacity = count === 0 ? '0.5' : '1';
  }

  songCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateSelectedCount);
  });

  selectAllBtn.addEventListener('click', function() {
    songCheckboxes.forEach(checkbox => {
      if (!checkbox.disabled) {
        checkbox.checked = true;
      }
    });
    updateSelectedCount();
  });

  deselectAllBtn.addEventListener('click', function() {
    songCheckboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
    updateSelectedCount();
  });

  selectAvailableBtn.addEventListener('click', function() {
    availableSongCheckboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
    updateSelectedCount();
  });

  selectAllCheckbox.addEventListener('change', function() {
    const isChecked = this.checked;
    availableSongCheckboxes.forEach(checkbox => {
      checkbox.checked = isChecked;
    });
    updateSelectedCount();
  });

  updateSelectedCount();
});
</script>