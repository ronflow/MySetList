<!-- app/views/artist_sets/show_sets_pub.html.erb -->
<div style="zoom: 75%;">
  <p style="color: green"><%= notice %></p>

  <div>
    <%= render @artist_set %>
  </div>

  <div>
    <%= link_to "Back to sets", artist_path(@artist_set.artist), 
        role: "button" %>
  </div>

  <hr>

  <!-- PRIMEIRA TABELA: Músicas no Set -->
  <h2>Músicas no Set (<%= @songs.count %>)</h2>

  <!-- Formulário de busca para músicas do set -->
  <%= form_with url: show_sets_pub_artist_artist_set_path(@artist_set.artist, @artist_set), method: :get, local: true do %>
    <%= label_tag :search_set, "Buscar músicas no set" %>
    <%= text_field_tag :search_set, params[:search_set] %>
    <%= submit_tag "Buscar no Set", 
        role: "button" %>
    <%= link_to "Mostrar todas do set", show_sets_pub_artist_artist_set_path(@artist_set.artist, @artist_set),
        role: "button" %>
  <% end %>

  <br>

  <% if @songs.present? %>
    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc;">
      <table>
        <thead>
          <tr>
            <th>Música</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <% @songs.each do |song| %>
            <tr>
              <td><%= song.name %></td>
              <td>
                <%= button_to "Remover", remover_musicas_artist_artist_set_path(@artist_set.artist, @artist_set), 
                    method: :delete, 
                    params: { song_ids: [song.id] },
                    style: "background-color: #dc3545; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;",
                    confirm: "Remover '#{song.name}' do set?",
                    local: true %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <p style="color: gray; font-style: italic;">
      <%= params[:search_set].present? ? "Nenhuma música encontrada no set." : "Nenhuma música no set ainda." %>
    </p>
  <% end %>

  <hr>

  <!-- SEGUNDA TABELA: Todas as Músicas Disponíveis com Seleção Múltipla -->
  <h2>Adicionar Músicas ao Set</h2>

  <!-- Formulário de busca para todas as músicas -->
  <%= form_with url: show_sets_pub_artist_artist_set_path(@artist_set.artist, @artist_set), method: :get, local: true do %>
    <%= label_tag :query, "Buscar música" %>
    <%= text_field_tag :query, params[:query] %>
    <%= submit_tag "Buscar", 
        role: "button" %>
    <%= link_to "Mostrar todas", show_sets_pub_artist_artist_set_path(@artist_set.artist, @artist_set),
        role: "button" %>
    <%= link_to "Ordenar por nome", show_sets_pub_artist_artist_set_path(@artist_set.artist, @artist_set, order: "name"),
        role: "button" %>
  <% end %>

  <br>

  <% if @all_songs.present? %>
    <h3>
      <%= if params[:query].present?
            "Músicas encontradas (#{@all_songs.count})"
          else
            "Todas as músicas disponíveis (#{@all_songs.count})"
          end %>
    </h3>
    
    <!-- Formulário para seleção múltipla -->
    <%= form_with url: adicionar_musicas_artist_artist_set_path(@artist_set.artist, @artist_set), 
        method: :post, local: true, id: "multiple-songs-form" do |form| %>
      
      <!-- Botões de controle -->
      <div>
        <button type="button" id="select-all-btn" 
                role: "button"; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Selecionar Todas</button>
        <button type="button" id="deselect-all-btn" 
                role: "button"; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Desmarcar Todas</button>
        <button type="button" id="select-available-btn" 
                role: "button"; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Selecionar Apenas Disponíveis</button>
        <%= form.submit "Inserir Músicas Selecionadas", 
            id: "submit-selected-btn", 
            style: "background-color: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;",
            confirm: "Adicionar músicas selecionadas ao set?" %>
        <span id="selected-count" style="margin-left: 10px; font-weight: bold; color: #007bff;">0 músicas selecionadas</span>
      </div>
    
      <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc;">
        <table>
          <thead>
            <tr>
              <th style="width: 40px;">
                <input type="checkbox" id="select-all-checkbox" title="Selecionar/Desmarcar todas">
              </th>
              <th>Música</th>
              <th>Status</th>
              <th>Ação Individual</th>
            </tr>
          </thead>
          <tbody>
            <% @all_songs.each do |song| %>
              <% is_in_set = @songs.include?(song) %>
              <tr class="<%= 'already-in-set' if is_in_set %>">
                <td>
                  <input type="checkbox" 
                         name="song_ids[]" 
                         value="<%= song.id %>" 
                         class="song-checkbox <%= 'available-song' unless is_in_set %>"
                         data-song-name="<%= song.name %>"
                         data-in-set="<%= is_in_set %>"
                         <%= 'disabled' if is_in_set %>>
                </td>
                <td>
                  <span class="<%= 'text-muted' if is_in_set %>"><%= song.name %></span>
                </td>
                <td>
                  <% if is_in_set %>
                    <span style="color: green; font-weight: bold;">Adicionada ao set</span>
                  <% else %>
                    <span style="color: #666;">Disponível</span>
                  <% end %>
                </td>
                <td>
                  <% unless is_in_set %>
                    <%= button_to "Adicionar", adicionar_musicas_artist_artist_set_path(@artist_set.artist, @artist_set), 
                        method: :post, 
                        params: { song_ids: [song.id] },
                        style: "background-color: #28a745; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;",
                        local: true %>
                  <% else %>
                    <span style="color: #ccc; font-size: 12px;">-</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  <% else %>
    <p>Use a busca acima para encontrar músicas.</p>
  <% end %>

  <hr>

  <div>  
    <%= button_to "Destroy this artist set", @artist_set, method: :delete,
        style: "background-color: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;",
        confirm: "Tem certeza que deseja deletar este set?" %>
  </div>
</div>

<!-- JavaScript permanece o mesmo -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const selectAllBtn = document.getElementById('select-all-btn');
  const deselectAllBtn = document.getElementById('deselect-all-btn');
  const selectAvailableBtn = document.getElementById('select-available-btn');
  const selectAllCheckbox = document.getElementById('select-all-checkbox');
  const selectedCountSpan = document.getElementById('selected-count');
  const submitBtn = document.getElementById('submit-selected-btn');
  
  const songCheckboxes = document.querySelectorAll('.song-checkbox');
  const availableSongCheckboxes = document.querySelectorAll('.song-checkbox.available-song');

  function updateSelectedCount() {
    const checkedBoxes = document.querySelectorAll('.song-checkbox:checked');
    const count = checkedBoxes.length;
    selectedCountSpan.textContent = `${count} música${count !== 1 ? 's' : ''} selecionada${count !== 1 ? 's' : ''}`;
    
    submitBtn.disabled = count === 0;
    submitBtn.style.opacity = count === 0 ? '0.5' : '1';
  }

  songCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateSelectedCount);
  });

  selectAllBtn.addEventListener('click', function() {
    songCheckboxes.forEach(checkbox => {
      if (!checkbox.disabled) {
        checkbox.checked = true;
      }
    });
    updateSelectedCount();
  });

  deselectAllBtn.addEventListener('click', function() {
    songCheckboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
    updateSelectedCount();
  });

  selectAvailableBtn.addEventListener('click', function() {
    availableSongCheckboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
    updateSelectedCount();
  });

  selectAllCheckbox.addEventListener('change', function() {
    const isChecked = this.checked;
    availableSongCheckboxes.forEach(checkbox => {
      checkbox.checked = isChecked;
    });
    updateSelectedCount();
  });

  updateSelectedCount();
});
</script>