<!-- filepath: c:\DEV\MySetList\app\views\songs\import_line.html.erb -->
<h2>Tratamento de Importa√ß√£o - Linha <%= @csv_index + 1 %> de <%= @csv_lines.size %></h2>
<p><strong>Progresso:</strong> <%= @imported_count %> importadas</p>

<% if @found %>
  <h3>‚úÖ M√∫sica encontrada no banco</h3>
  <p><strong>ID:</strong> <%= @song.id %></p>
  <p><strong>Nome:</strong> <%= @song.name %></p>
  <p><strong>Banda:</strong> <%= @song.band %></p>
  <p><strong>ISRC:</strong> <%= @song.isrc.presence || "N√£o informado" %></p>
  <p><strong>Letra atual:</strong> <%= @letra_atual %></p>
  <p><strong>Letra do CSV:</strong> <%= @letra_csv %></p>
  
  <%= button_to "‚ùå Cancelar importa√ß√£o", cancel_import_songs_path, method: :post, style: "background-color: #dc3545;" %>
  <%= button_to "üìù Importar letra", import_line_action_songs_path(action_type: "import_lyrics"), method: :post, style: "background-color: #28a745;" %>
  <%= button_to "‚è≠Ô∏è Pr√≥xima m√∫sica", import_line_action_songs_path(action_type: "next"), method: :post, style: "background-color: #6c757d;" %>

<% else %>
  <h3>üîç M√∫sica n√£o encontrada - Buscar no MusicBrainz</h3>
  <p><strong>Nome da m√∫sica:</strong> <%= @song_name %></p>
  <p><strong>Banda:</strong> <%= @band %></p>
  
  <% if @musicbrainz_results.any? %>
    <h4>üéµ Op√ß√µes encontradas no MusicBrainz:</h4>
    <%= form_with url: import_line_action_songs_path, method: :post, local: true do |form| %>
      <%= form.hidden_field :action_type, value: "import_music" %>
      
      <% @musicbrainz_results.each do |result| %>
        <div style="border: 1px solid #ccc; padding: 10px; margin: 5px 0; border-radius: 4px;">
          <%= form.radio_button :musicbrainz_option, result[:id], 
              checked: loop.first,
              data: { 
                isrc: result[:isrc],
                title: result[:title],
                artist: result[:artist] 
              } %>
          <strong><%= result[:title] %></strong> - <%= result[:artist] %>
          <% if result[:isrc].present? %>
            <br><small style="color: #28a745;">‚úÖ ISRC: <%= result[:isrc] %></small>
          <% else %>
            <br><small style="color: #ffc107;">‚ö†Ô∏è Sem ISRC</small>
          <% end %>
          <small style="color: #888;">(Score: <%= result[:score] %>)</small>
        </div>
      <% end %>
      
      <!-- CAMPOS OCULTOS -->
      <%= form.hidden_field :selected_isrc, id: "selected_isrc" %>
      <%= form.hidden_field :selected_title, id: "selected_title" %>
      <%= form.hidden_field :selected_artist, id: "selected_artist" %>
      
      <div style="margin: 15px 0;">
        <%= button_to "‚ùå Cancelar", cancel_import_songs_path, method: :post, style: "background-color: #dc3545; margin-right: 10px;" %>
        <%= form.submit "üíæ Importar do MusicBrainz", style: "background-color: #28a745; margin-right: 10px;" %>
        <%= button_to "‚è≠Ô∏è Pr√≥xima m√∫sica", import_line_action_songs_path(action_type: "next"), method: :post, style: "background-color: #6c757d;" %>
      </div>
    <% end %>
  <% else %>
    <p style="color: #ffc107;">‚ö†Ô∏è Nenhuma m√∫sica encontrada no MusicBrainz</p>
  <% end %>

  <!-- OP√á√ÉO PARA CRIAR SEM MUSICBRAINZ -->
  <div style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 4px;">
    <h4>üìù Criar m√∫sica sem MusicBrainz</h4>
    <p><strong>Nome:</strong> <%= @song_name %></p>
    <p><strong>Banda:</strong> <%= @band %></p>
    <p style="color: #666;"><em>Ser√° criada sem ISRC</em></p>
    
    <%= button_to "üíæ Criar m√∫sica simples", import_line_action_songs_path(action_type: "import_music"), method: :post, style: "background-color: #ffc107; margin-right: 10px;" %>
  </div>

  <!-- BOT√ïES DE NAVEGA√á√ÉO -->
  <div style="margin-top: 20px;">
    <%= button_to "‚ùå Cancelar importa√ß√£o", cancel_import_songs_path, method: :post, style: "background-color: #dc3545; margin-right: 10px;" %>
    <%= button_to "‚è≠Ô∏è Pr√≥xima m√∫sica", import_line_action_songs_path(action_type: "next"), method: :post, style: "background-color: #6c757d;" %>
  </div>
<% end %>

<hr>
<p><strong>Letra completa do CSV:</strong></p>
<pre class="lyrics-preview"><%= @letra_csv_full %></pre>

<style>
  .lyrics-preview {
    font-family: 'Courier New', 'Courier', monospace !important;
    white-space: pre-wrap;
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    max-height: 300px;
    overflow-y: auto;
    font-size: 0.9em;
    line-height: 1.3;
  }
</style>

<hr>
<p><strong>Letra completa do CSV:</strong></p>
<pre style="background-color: #f8f9fa; padding: 10px; border-radius: 4px; white-space: pre-wrap;"><%= @letra_csv_full %></pre>

<!-- JAVASCRIPT PARA CAPTURA DO ISRC -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const radioButtons = document.querySelectorAll('input[type=radio][name="musicbrainz_option"]');
    const isrcField = document.getElementById('isrc_manual');
    const selectedIsrcField = document.getElementById('selected_isrc');
    const selectedTitleField = document.getElementById('selected_title');
    const selectedArtistField = document.getElementById('selected_artist');

    // Fun√ß√£o para atualizar campos com base na sele√ß√£o
    function updateFields(radio) {
      if (selectedIsrcField) selectedIsrcField.value = radio.dataset.isrc || "";
      if (selectedTitleField) selectedTitleField.value = radio.dataset.title || "";
      if (selectedArtistField) selectedArtistField.value = radio.dataset.artist || "";
      
      // Auto-preenche o campo ISRC manual
      if (isrcField && radio.dataset.isrc) {
        isrcField.value = radio.dataset.isrc;
      }
    }

    // Adiciona listener para cada radio button
    radioButtons.forEach(function(radio) {
      radio.addEventListener('change', function() {
        if (this.checked) {
          updateFields(this);
        }
      });
    });

    // Inicializa com o primeiro radio selecionado
    const firstChecked = document.querySelector('input[type=radio][name="musicbrainz_option"]:checked');
    if (firstChecked) {
      updateFields(firstChecked);
    }

    // Valida√ß√£o do formato ISRC
    if (isrcField) {
      isrcField.addEventListener('input', function() {
        const value = this.value.toUpperCase();
        this.value = value;
        
        const isValid = /^[A-Z]{2}[A-Z0-9]{3}[0-9]{7}$/.test(value);
        this.style.borderColor = value === '' || isValid ? '#ccc' : '#ff0000';
      });
    }
  });
</script>